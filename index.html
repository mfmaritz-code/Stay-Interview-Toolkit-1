<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stay Interview Toolkit</title>
    
    <!-- Professional Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Styling Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & AI Engine Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            font-family: 'Montserrat', sans-serif !important; 
            background-color: #fcfcfd;
        }
        .soft-shadow {
            box-shadow: 0 10px 30px -12px rgba(0, 0, 0, 0.05);
        }
        @media print {
            .no-print { display: none !important; }
            .print-block { display: block !important; }
            @page { size: portrait; margin: 15mm; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icon Helper ---
        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        // --- AI Coaching Logic ---
        const generateStayGuide = async (config) => {
            const apiKey = ""; // Set by environment
            const finalTrigger = config.trigger === "Other" ? config.customTrigger : config.trigger;
            const finalPersona = config.persona === "Other" ? config.customPersona : config.persona;
            
            const systemPrompt = "Identity: Thumbtack Stay Interview Coach. Philosophy: Soft, meaningful retention insights. Instruction: Generate 7 tailored questions and a Recommended Action Plan. Format: JSON.";
            const userPrompt = `Context: Trigger: ${finalTrigger}, Type: ${config.type}, Persona: ${finalPersona}, Sentiment: ${config.sentiment}`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const result = await response.json();
            return JSON.parse(result.candidates[0].content.parts[0].text);
        };

        // --- UI Components ---
        function App() {
            const [view, setView] = useState('form');
            const [loading, setLoading] = useState(false);
            const [guide, setGuide] = useState(null);
            const [config, setConfig] = useState({
                trigger: '', persona: '', sentiment: '', type: 'Standard (Manager-led)'
            });

            const TRIGGERS = ["90-Day Milestone", "Post-Promotion", "Post-Reorganization", "Annual Check-In", "At-Risk Signal", "Other"];
            const PERSONAS = ["High Performer / IC", "Recently Promoted / New to Role", "Tenured / Steady Performer", "At-Risk / Showing Disengagement", "New Hire (under 6 months)"];
            const SENTIMENTS = ["Energized but stretched", "Quiet/withdrawn recently", "Frustrated", "Thriving", "Other"];

            const handleGenerate = async () => {
                setLoading(true);
                try {
                    const result = await generateStayGuide(config);
                    setGuide(result);
                    setView('results');
                } catch (e) {
                    alert("AI is preparing. Please try again in a moment.");
                }
                setLoading(false);
            };

            const saveReferenceList = () => {
                const allQs = guide.tieredQuestions.flatMap(c => c.questions);
                const questionsHtml = allQs.map((q, i) => `<p style="margin-bottom:15px;"><b>${i+1}. ${q}</b></p>`).join('');
                const matrixRows = guide.actionMatrix.map(row => `<tr><td style="border:1px solid #ddd;padding:8px;"><b>${row.insight}</b></td><td style="border:1px solid #ddd;padding:8px;">${row.controllable}</td><td style="border:1px solid #ddd;padding:8px;">${row.uncontrollable}</td></tr>`).join('');
                
                const fullHtml = `<html><body style="font-family:sans-serif;padding:40px;max-width:800px;margin:auto;"><h1>Stay Interview Reference</h1><p><i>Prepared for: ${config.persona}</i></p><hr/><h3>Opening Script</h3><p>"${guide.openingScript}"</p><h3>Questions</h3>${questionsHtml}<h3>Recommended Action Plan</h3><table style="width:100%;border-collapse:collapse;"><thead><tr style="background:#eee;"><th>Insight</th><th>Manager Action</th><th>Escalation</th></tr></thead><tbody>${matrixRows}</tbody></table></body></html>`;
                const blob = new Blob([fullHtml], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "Stay_Interview_Reference.html";
                link.click();
            };

            const logFeedback = () => {
                const baseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSf0ZYrWzdNensiO56FpXgnIVFHuKDz57zZGoayviBeTsdK4CQ/viewform";
                const params = new URLSearchParams({
                    "usp": "pp_url",
                    "entry.264105683": config.trigger,
                    "entry.359219502": config.persona
                });
                const allQs = guide.tieredQuestions.flatMap(c => c.questions);
                const IDs = ["entry.1957147871", "entry.1390220802", "entry.435531527", "entry.1635334784", "entry.1081351633", "entry.1090088368", "entry.741519336"];
                allQs.forEach((q, i) => { if(IDs[i]) params.append(IDs[i], `${i+1}. ${q}\n\n\n`); });
                window.open(`${baseUrl}?${params.toString()}`, '_blank');
            };

            return (
                <div className="max-w-4xl mx-auto p-6 md:p-12">
                    <header className="mb-12 no-print">
                        <div className="flex items-center gap-4 mb-4">
                            <div className="w-14 h-14 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg rotate-3">
                                <Icon name="messages-square" size={32} className="text-white" />
                            </div>
                            <h1 className="text-3xl font-bold tracking-tight text-gray-900">Stay Interview Toolkit</h1>
                        </div>
                        <p className="text-gray-500 font-medium text-sm border-l-4 border-blue-600 pl-4 max-w-2xl leading-relaxed">
                            Conduct meaningful retention conversations at the moments that matter most.
                        </p>
                    </header>

                    {view === 'form' ? (
                        <div className="bg-white rounded-[2rem] p-8 md:p-10 soft-shadow border border-gray-100 animate-in fade-in slide-in-from-bottom-4">
                            <div className="mb-10 p-5 bg-amber-50 border border-amber-100 rounded-2xl flex gap-4">
                                <Icon name="shield-alert" className="text-amber-600 shrink-0 mt-1" />
                                <div className="text-xs text-amber-900 leading-relaxed font-medium">
                                    <strong className="block mb-1">Confidentiality Notice</strong>
                                    This conversation is private. Escalate immediately if legal or safety concerns are raised.
                                </div>
                            </div>

                            <div className="space-y-10">
                                <div>
                                    <label className="text-[10px] font-black uppercase tracking-[0.25em] text-gray-400 mb-6 block">1. Select Trigger</label>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {TRIGGERS.map(t => (
                                            <button key={t} onClick={() => setConfig({...config, trigger: t})} className={`p-5 text-xs font-bold rounded-2xl border text-left transition-all ${config.trigger === t ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-100 hover:border-blue-200'}`}>{t}</button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <label className="text-[10px] font-black uppercase tracking-[0.25em] text-gray-400 mb-6 block">2. Employee Persona</label>
                                    <select value={config.persona} onChange={(e) => setConfig({...config, persona: e.target.value})} className="w-full p-5 rounded-2xl border border-gray-100 font-bold text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50/50">
                                        <option value="">Select persona...</option>
                                        {PERSONAS.map(p => <option key={p} value={p}>{p}</option>)}
                                    </select>
                                </div>

                                <button 
                                    disabled={!config.trigger || !config.persona || loading}
                                    onClick={handleGenerate}
                                    className="w-full bg-blue-600 text-white font-bold py-6 rounded-[1.5rem] shadow-2xl shadow-blue-200 hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center gap-3 transition-all transform active:scale-[0.98]"
                                >
                                    {loading ? "Building Framework..." : "Get Your Coaching Framework"}
                                    {!loading && <Icon name="brain-circuit" />}
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-6 animate-in fade-in zoom-in-95">
                            <div className="bg-white rounded-[2.5rem] p-10 border border-gray-100 shadow-sm">
                                <div className="flex justify-between items-center mb-10 no-print">
                                    <h2 className="text-2xl font-bold italic text-gray-900">Framework Ready</h2>
                                    <div className="flex gap-2">
                                        <button onClick={saveReferenceList} className="p-3 bg-blue-50 text-blue-600 rounded-2xl hover:bg-blue-100 transition-colors" title="Save Reference List">
                                            <Icon name="file-down" />
                                        </button>
                                        <button onClick={() => setView('form')} className="p-3 bg-gray-100 text-gray-500 rounded-2xl hover:bg-gray-200 transition-colors" title="Reset">
                                            <Icon name="refresh-cw" />
                                        </button>
                                    </div>
                                </div>

                                <div className="bg-blue-50 p-8 rounded-[2rem] border-l-8 border-blue-500 mb-12 font-medium text-lg text-blue-900 leading-relaxed">
                                    "{guide.openingScript}"
                                </div>

                                <div className="space-y-8 mb-12">
                                    <h3 className="font-black text-[10px] uppercase tracking-[0.25em] text-blue-600 border-b border-blue-100 pb-3">Tailored Questions</h3>
                                    {guide.tieredQuestions.map((cat, i) => (
                                        <div key={i} className="grid gap-4">
                                            {cat.questions.map((q, j) => (
                                                <div key={j} className="flex gap-4 items-start p-6 bg-gray-50/50 rounded-2xl border border-gray-100">
                                                    <div className="mt-1.5 w-2 h-2 bg-blue-400 rounded-full shrink-0" />
                                                    <p className="text-base font-semibold text-gray-800 leading-relaxed">{q}</p>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>

                                <div className="bg-slate-900 rounded-[2rem] p-10 text-white no-print">
                                    <div className="flex items-center gap-3 mb-4">
                                        <Icon name="check-circle-2" className="text-blue-400" size={24} />
                                        <h3 className="text-xl font-bold">Log Your Session</h3>
                                    </div>
                                    <p className="text-slate-400 text-sm mb-8 leading-relaxed font-medium">Use the central tracker to document feedback. Questions are pre-filled with designated space for your notes.</p>
                                    <button onClick={logFeedback} className="w-full bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-bold uppercase tracking-widest text-xs flex items-center justify-center gap-3 transition-all shadow-xl shadow-blue-900/40">
                                        Open Tracker & Log Feedback <Icon name="external-link" size={16} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
